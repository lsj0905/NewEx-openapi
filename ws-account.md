# websocket资产及订单

## 简介

### 接入url
wss://api.ws.newex.io/v1

### 心跳消息
当用户的Websocket客户端连接到Websocket服务器后，服务器会定期（当前设为20秒）向其发送ping消息并包含一整数值如下：
```
{ "op":"ping", "ts":1492420473027 } (资产订单推送)
```
当用户的Websocket客户端接收到此心跳消息后，应返回pong消息并包含同一整数值：
```
{ "op":"pong", "ts":1492420473027 } （资产订单推送）
```
`当Websocket服务器连续三次发送了`ping`消息却没有收到任何一次`pong`消息返回后，服务器将主动断开与此客户端的连接。`



### 订阅主题
成功建立与Websocket服务器的连接后，Websocket客户端发送如下请求以订阅特定主题：
```
{
  "op": "operation type, 'sub' for subscription, 'unsub' for unsubscription",
  "topic": "topic to sub",
  "cid": "id generate by client"
}
```
成功订阅后，Websocket客户端将收到确认：
```
{
  "op": "operation type, refer to the operation which triggers this response",
  "cid": "id1",
  "error-code": 0, // 0 for no error
  "topic": "topic to sub if the op is sub",
  "ts": 1489474081631
}
```
之后, 一旦所订阅的主题有更新，Websocket客户端将收到服务器推送的更新消息（push）：
```
{
  "op": "notify",
  "topic": "topic of this notify",
  "ts": 1489474082831,
  "data": {
    // data of specific topic update
  }
}
```


### 取消订阅
取消订阅的格式如下：
```
{
  "op": "unsub",
  "topic": "accounts",
  "cid": "client generated id"
}
```

取消订阅成功确认：
```
{
  "op": "unsub",
  "topic": "accounts",
  "cid": "id generated by client",
  "err-code": 0,
  "ts": 1489474081631
}
```


### 请求数据
Websocket服务器同时支持一次性请求数据（pull）。

当与Websocket服务器成功建立连接后，以下三个主题可供用户请求：
```
accounts.list
orders.list
orders.detail
```


### 限频

#### 数据请求（sub）限频规则

限频规则基于API key而不是连接。当sub数量超出限值时，Websocket客户端将收到"too many request"错误码。具体规则如下：

单个连接每秒最多50次sub和50次unsub。 单个连接sub总量限制100个，sub总量达到限额后不允许再sub，但每次unsub可以减少sub总量的计数。比如：30个sub后unsub 1个，此时sub总量count为29，还有71个sub总量可用。

#### 数据请求（req）限频规则

限频规则基于API key而不是连接。当请求频率超出限值时，Websocket客户端将收到"too many request"错误码。以下为各主题当前限频设定：
```
accounts.list: once every 2 seconds

orders.list AND orders.detail: once every 5 seconds
```


### 鉴权

鉴权请求格式如下：
```
{
  "op": "auth",
  "AccessKeyId": "e2xxxxxx-99xxxxxx-84xxxxxx-7xxxx",
  "SignatureMethod": "HmacSHA256",
  "SignatureVersion": "2",
  "Timestamp": "2017-05-11T15:19:30",
  "Signature": "4F65x5A2bLyMWVQj3Aqp+B4w+ivaA7n5Oi2SuYtCJ9o=",
}
```

鉴权成功后返回数据格式如下：
```
{
    "action": "req",
    "code": 200,
    "ch": "auth",
    "data": {}
}
```

参数说明
| 参数 | 数据类型 | 是否必须 | 描述 |
|:-:|:-:|:-:|:-:|
| cid | string | true | Client 请求唯一 ID |
| op | string | true | 请求主题，鉴权固定值为auth |
| AccessKeyId | string | true | 您申请的API Key中的AccessKey |
| SignatureMethod | string | true | 签名方法，用户计算签名寄语哈希的协议，固定值为HmacSHA256 |
| SignatureVersion | string | true | 签名协议的版本，此处使用 2 |
| Timestamp | string | true | 时间戳，您发出请求的时间（UTC时间）在查询请求中包含此值有助于防止第三方截取您的请求。 |
| Signature | string | true | 签名, 计算得出的值，用于确保签名有效和未被篡改 |


```
参考 [签名认证](signature.md) 生成有效签名，签名计算中请求方法固定值为GET
```




## 订阅订单更新

订阅账户下的订单更新

#### 主题订阅
orders.$symbol.update

| 参数 | 数据类型 | 是否必须 | 描述 | 取值范围 |
|:-:|:-:|:-:|:-:|:-:|
| symbol | string | true | 交易对 | "newusdt", "btcusdt", "newbtc", 支持通配符"*" |

#### Subscribe request
```
{
  "op": "sub",
  "cid": "40sG903yz80oDFWr",
  "topic": "orders.htusdt.update"
}
```

#### Response
```
{
  "op": "sub",
  "ts": 1489474081631,
  "topic": "orders.htusdt.update",
  "err-code": 0,
  "cid": "40sG903yz80oDFWr"  
}
```

#### 数据更新字段列表

| 参数 | 数据类型 | 描述 |
|:-:|:-:|:-:|
| order-id | integer | 订单编号 |
| symbol | string | 交易代码 |
| order-state | string | 订单状态, 有效取值: submitted, partial-filled, filled, canceled, partial-canceled |
| role | string | 最近成交角色（当order-state = submitted, canceled, partial-canceled时，role 为缺省值taker；当order-state = filled, partial-filled 时，role 取值为taker 或maker。） |
| price | string | 最新价 |
| filled-amount | string | 最近成交数量 |
| filled-cash-amount | string | 最近成交数额 |
| unfilled-amount | string | 最近未成交数量 |
| order-type | string | 订单类型，包括bbuy-limit, sell-limit |


#### Response
```
{
    "op": "notify",
    "ts": 1522856623232,
    "topic": "orders.htusdt.update", 
    "data": {
        "order-id": 2039498445,
        "unfilled-amount": "0.000000000000000000",
        "filled-amount": "5000.000000000000000000",
        "price": "1.662100000000000000",
        "symbol": "htusdt",
        "match-id": 94984,
        "filled-cash-amount": "8301.357280000000000000",
        "role": "taker|maker",
        "order-state": "filled",
        "client-order-id": "a0001",
        "order-type": "buy-limit"
    }
}
```



## 请求用户资产数据

查询当前用户的所有账户余额数据

#### 主题订阅
accounts.list


#### Subscribe request
```
{
  "op": "req",
  "cid": "40sG903yz80oDFWr",
  "topic": "accounts.list",
}
```

| 参数 | 数据类型 | 描述 |
|:-:|:-:|:-:|
| op | string | 必填；操作名称，固定值为 req |
| cid | string | 选填；Client 请求唯一 ID |
| topic | string | 必填；固定值为accounts.list |

#### Response

| 参数 | 数据类型 | 描述 |
|:-:|:-:|:-:|
| id | long | 账户ID |
| state | string | 账户状态 |
| list | array | 账户列表 |
| currency | string | 子账户币种 |
| type | string | 子账户类型 |
| balance | string | 子账户余额 |

#### Example (Successful)
```
{
    "op": "req",
    "topic": "accounts.list",
    "cid": "40sG903yz80oDFWr",
    "err-code": 0,
    "ts": 1489474082831,
    "data": [
      {
        "id": 419013,
        "state": "working",
        "list": [
          {
            "currency": "usdt",
            "type": "trade",
            "balance": "500009195917.4362872650"
          },
          {
            "currency": "usdt",
            "type": "frozen",
            "balance": "9786.6783000000"
          }
        ]
      },
      {
        "id": 35535,
        "state": "working",
        "list": [
          {
            "currency": "eth",
            "type": "trade",
            "balance": "499999894616.1302471000"
          },
          {
            "currency": "eth",
            "type": "frozen",
            "balance": "9786.6783000000"
          }
        ]
      }
    ]
}
```

#### Example (Failed)
```
{
    "op": "req",
    "topic": "accounts.list",
    "cid": "40sG903yz80oDFWr",
    "err-code": 12001, //Response codes, 0 represent success; others value is error
    "err-msg": "detail of error message",
    "ts": 1489474081631
}
```



## 请求当前及历史订单

根据设定条件查询当前委托、历史委托

#### 主题订阅
order.list


#### Subscribe request
```
{
  "op": "req",
  "topic": "orders.list",
  "cid": "40sG903yz80oDFWr",
  "symbol": "htusdt",
  "states": "submitted,partial-filled"
}
```

| 参数 | 数据类型 | 是否必须 | 描述 | 取值范围 |
|:-:|:-:|:-:|:-:|:-:|
| account-id | int | true | 账户id | NA |
| symbol | string | true | 交易对 | "newusdt", "btcusdt", "newbtc" |
| types | string | false | 查询的订单类型组合，使用','分割 | buy-limit, sell-limit |
| states | string | true | 查询的订单状态组合，使用','分割 | submitted, partial-filled, partial-canceled, filled, canceled, created |
| start-date | string | false | 查询开始日期, 日期格式yyyy-mm-dd | 默认-61d |
| end-date | string | false | 查询开始日期, 日期格式yyyy-mm-dd | 默认值today |
| from | string | false | 查询起始 ID | NA |
| direct | string | false | 查询方向 | next或prev，默认next |
| size | string | false | 查询记录大小 | [1, 100]，默认100 |


#### Response

| 参数 | 数据类型 | 描述 |
|:-:|:-:|:-:|
| id | long | 订单ID |
| symbol | string | 交易对 |
| account-id | long | 账户ID |
| amount | string | 订单数量 |
| price | string | 订单价格 |
| created-at | long | 订单创建时间 |
| type | string | 订单类型，请参考订单类型说明 |
| filled-amount | string | 已成交数量 |
| filled-cash-amount | string | 已成交总金额 |
| filled-fees | string | 已成交手续费 |
| finished-at | long | 最后成交时间 |
| cancel-at | long | 撤单时间 |
| source | string | 订单来源，请参考订单来源说明 |
| state | string | 订单状态，请参考订单状态说明 |
| stop-price | string | 止盈止损订单触发价格 |
| operator | string | 止盈止损订单触发价运算符 |


#### Example (Successful)
```
{
  "op": "req",
  "topic": "orders.list",
  "cid": "40sG903yz80oDFWr",
  "err-code": 0,
  "ts": 1522856623232,
  "data": [
    {
      "id": 2039498445,
      "symbol": "htusdt",
      "account-id": 100077,
      "amount": "5000.000000000000000000",
      "price": "1.662100000000000000",
      "created-at": 1522858623622,
      "type": "buy-limit",
      "filled-amount": "5000.000000000000000000",
      "filled-cash-amount": "8301.357280000000000000",
      "filled-fees": "8.000000000000000000",
      "finished-at": 1522858624796,
      "source": "api",
      "state": "filled",
      "canceled-at": 0
    }
  ]
}
```


## 以订单编号请求订单

以订单编号请求订单数据

#### 主题订阅
orders.detail


#### Subscribe request
```
{
  "op": "req",
  "topic": "orders.detail",
  "order-id": "2039498445",
  "cid": "40sG903yz80oDFWr"
}
```

| 参数 | 数据类型 | 是否必须 | 描述 | 取值范围 |
|:-:|:-:|:-:|:-:|:-:|
| op | string | true | 操作名称，固定值为 req |  |
| topic | string | false | 固定值为 orders.detail |  |
| cid | string | true | Client 请求唯一 ID |  |
| order-id | string | true | 订单ID |  |


#### Response

| 参数 | 数据类型 | 描述 |
|:-:|:-:|:-:|
| id | long | 订单ID |
| symbol | string | 交易对 |
| account-id | long | 账户ID |
| amount | string | 订单数量 |
| price | string | 订单价格 |
| created-at | long | 订单创建时间 |
| type | string | 订单类型，请参考订单类型说明 |
| filled-amount | string | 已成交数量 |
| filled-cash-amount | string | 已成交总金额 |
| filled-fees | string | 已成交手续费 |
| finished-at | long | 最后成交时间 |
| cancel-at | long | 撤单时间 |
| source | string | 订单来源，请参考订单来源说明 |
| state | string | 订单状态，请参考订单状态说明 |
| stop-price | string | 止盈止损订单触发价格 |
| operator | string | 止盈止损订单触发价运算符 |


#### Example (Successful)
```
{
  "op": "req",
  "topic": "orders.detail",
  "cid": "40sG903yz80oDFWr",
  "err-code": 0,
  "ts": 1522856623232,
  "data": {
    "id": 2039498445,
    "symbol": "htusdt",
    "account-id": 100077,
    "amount": "5000.000000000000000000",
    "price": "1.662100000000000000",
    "created-at": 1522858623622,
    "type": "buy-limit",
    "filled-amount": "5000.000000000000000000",
    "filled-cash-amount": "8301.357280000000000000",
    "filled-fees": "8.000000000000000000",
    "finished-at": 1522858624796,
    "source": "api",
    "state": "filled",
    "canceled-at": 0
  }
}
```
